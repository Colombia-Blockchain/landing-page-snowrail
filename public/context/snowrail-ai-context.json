{
  "metadata": {
    "version": "1.0.0",
    "generatedAt": "2025-12-10T00:00:00Z",
    "project": "SnowRail",
    "description": "Contexto completo del proyecto SnowRail para inteligencia artificial"
  },
  "systemPrompt": "Eres un asistente especializado en SnowRail, una plataforma de orquestación autónoma de tesorería construida en Avalanche (AVAX). SnowRail permite gestionar tesorerías corporativas mediante una API única que maneja pagos, swaps y yield farming con arquitectura zero-trust y verificación criptográfica. El sistema utiliza protocolos x402 (HTTP 402 Payment Required), ERC-8004 (Agent Identity), EIP-3009 (Permit/Transfer Authorization) y está diseñado para permitir a agentes de IA ejecutar pagos cross-border sin intervención humana.",
  "projectOverview": {
    "name": "SnowRail",
    "type": "Autonomous Treasury Orchestrator",
    "purpose": "Puente entre pagos crypto y fiat usando Sovereign Agent Stack, permitiendo a agentes de IA ejecutar payroll cross-border sin intervención humana",
    "keyFeatures": [
      "Onchain Payments: Pagos USDC en Avalanche C-Chain con smart contract treasury",
      "Fiat Bridge: Conversión automática a pagos bancarios (ACH/wire) vía Rail API",
      "AI Agent Ready: Compatibilidad completa con x402 y ERC-8004 para pagos máquina-a-máquina",
      "Permanent Receipts: Cada transacción guardada inmutablemente en Arweave",
      "Real-time Dashboard: Monitoreo de ejecuciones de payroll, identidad de agente y estadísticas"
    ],
    "protocols": {
      "x402": "HTTP 402 Payment Required - Monetiza APIs con pruebas de pago criptográficas",
      "ERC-8004": "Discoverable agent identity card para sistemas de IA",
      "EIP-3009": "Gasless, signed token transfers",
      "Arweave": "Immutable receipts para compliance y verificación"
    },
    "blockchain": {
      "network": "Avalanche C-Chain",
      "testnet": "Fuji",
      "mainnet": "Avalanche",
      "nativeToken": "AVAX",
      "paymentToken": "USDC (6 decimals)"
    }
  },
  "architecture": {
    "components": {
      "frontend": {
        "tech": "React, Vite, TypeScript, Tailwind CSS, Lucide React",
        "purpose": "Aplicación web para monitoreo y ejecución",
        "port": 3000,
        "structure": {
          "/src/components": "Componentes UI (Dashboard, AgentIdentity, PaymentForm, etc.)",
          "/src/pages": "Páginas orquestadoras",
          "/src/hooks": "Lógica de negocio",
          "/src/lib/api.ts": "Cliente API"
        }
      },
      "backend": {
        "tech": "Node.js, TypeScript, Express",
        "purpose": "API REST con x402/ERC-8004 para pagos y metering",
        "port": 4000,
        "structure": {
          "/src/server.ts": "Entrypoint del servidor",
          "/src/api": "Rutas (payroll, treasury, agent, auth)",
          "/src/services": "Lógica de negocio + Arweave",
          "/src/x402": "Implementación de x402 + ERC-8004 + facilitator",
          "/src/config": "Configuración de entorno y red"
        },
        "database": {
          "orm": "Prisma",
          "dev": "SQLite",
          "production": "PostgreSQL"
        }
      },
      "smartContracts": {
        "tech": "Solidity ^0.8.20, Hardhat",
        "mainContract": "SnowRailTreasury.sol",
        "location": "/contracts/src/",
        "functions": {
          "requestPayment": "Emite evento de intención de pago (payee, amount, token)",
          "executePayment": "Transfiere tokens ERC-20 desde treasury a payee",
          "executeSwap": "Realiza swaps de tokens vía Trader Joe DEX (ej: AVAX -> USDC)",
          "authorizeSwap": "Autoriza swaps con límite máximo de amount",
          "getTokenBalance": "Consulta balance de token en treasury",
          "emergencyWithdraw": "Retiro de emergencia (solo owner)",
          "transferOwnership": "Transferir ownership del contrato"
        },
        "events": {
          "PaymentRequested": "Emitido cuando se solicita un pago",
          "PaymentExecuted": "Emitido cuando se ejecuta exitosamente",
          "PaymentFailed": "Emitido cuando falla (INSUFFICIENT_FUNDS, TRANSFER_FAILED)",
          "SwapAuthorized": "Emitido cuando se autoriza un swap",
          "SwapExecuted": "Emitido cuando se ejecuta un swap"
        }
      },
      "storage": {
        "arweave": {
          "purpose": "Recibos permanentes e inmutables",
          "format": "JSON con txHash, payrollId, timestamps, amounts"
        },
        "database": {
          "purpose": "Datos operacionales (payrolls, payments, users, companies)",
          "schema": "Prisma schema en /backend/prisma/schema.prisma"
        }
      },
      "fiatBridge": {
        "provider": "Rail API (Layer2 Financial)",
        "purpose": "Conversión de USDC on-chain a ACH/Wire fiat",
        "integration": "/backend/src/services/railClient.ts",
        "modes": {
          "sandbox": "https://sandbox.layer2financial.com/api",
          "production": "https://api.layer2financial.com/api"
        },
        "authentication": "OAuth2 Client Credentials",
        "endpoints": {
          "withdrawals": "POST /v1/withdrawals - Crear retiro fiat",
          "withdrawals/accept": "POST /v1/withdrawals/{id}/accept - Aceptar retiro"
        }
      }
    },
    "dataFlow": {
      "paymentFlow": [
        "1. Cliente/Agente envía request a API",
        "2. Middleware x402 valida pago (retorna 402 si falta)",
        "3. Backend verifica saldo en SnowRailTreasury contract",
        "4. Backend ejecuta executePayment() en contrato",
        "5. Backend confirma transacción on-chain",
        "6. Backend llama Rail API para iniciar retiro fiat",
        "7. Backend guarda recibo en Arweave",
        "8. Backend actualiza estado en base de datos"
      ]
    }
  },
  "environments": {
    "development": {
      "network": "fuji",
      "rpcUrl": "https://api.avax-test.network/ext/bc/C/rpc",
      "apiBaseUrl": "http://localhost:4000",
      "frontendUrl": "http://localhost:3000",
      "treasuryContract": "0xcba2318C6C4d9c98f7732c5fDe09D1BAe12c27be",
      "usdcAddress": "Variable según testnet",
      "database": "file:./prisma/dev.db (SQLite)"
    },
    "staging": {
      "network": "fuji",
      "rpcUrl": "https://api.avax-test.network/ext/bc/C/rpc",
      "apiBaseUrl": "https://staging-api.snowrail.xyz",
      "frontendUrl": "https://staging.snowrail.xyz",
      "treasuryContract": "Variable - desplegado en staging",
      "database": "PostgreSQL"
    },
    "production": {
      "network": "avalanche",
      "rpcUrl": "https://api.avax.network/ext/bc/C/rpc",
      "apiBaseUrl": "https://api.snowrail.xyz",
      "frontendUrl": "https://app.snowrail.xyz",
      "treasuryContract": "Variable - desplegado en mainnet",
      "database": "PostgreSQL"
    }
  },
  "apiEndpoints": {
    "baseUrls": {
      "development": "http://localhost:4000",
      "staging": "https://staging-api.snowrail.xyz",
      "production": "https://api.snowrail.xyz"
    },
    "contentType": "application/json",
    "endpoints": {
      "health": {
        "method": "GET",
        "path": "/health",
        "description": "Verifica estado del servicio",
        "authentication": "None",
        "request": {},
        "response": {
          "200": {
            "status": "ok",
            "timestamp": "ISO 8601 string"
          }
        }
      },
      "agentIdentity": {
        "method": "GET",
        "path": "/api/agent/identity",
        "description": "Obtiene tarjeta de identidad del agente ERC-8004",
        "authentication": "None",
        "request": {},
        "response": {
          "200": {
            "erc8004Version": "1.0",
            "agent": {
              "id": "snowrail-treasury-v1",
              "name": "SnowRail Treasury Agent",
              "description": "Autonomous treasury orchestration",
              "capabilities": ["treasury_management", "cross_border_payments", "payroll_execution"],
              "protocols": ["x402", "erc8004", "eip3009", "arweave"],
              "networks": ["avalanche", "avalanche-fuji"]
            },
            "metering": {
              "resources": [
                {
                  "id": "payroll_execute",
                  "price": "1",
                  "asset": "USDC",
                  "chain": "avalanche",
                  "description": "Execute international payroll"
                }
              ]
            }
          }
        }
      },
      "agentActivity": {
        "method": "GET",
        "path": "/api/agent/activity",
        "description": "Obtiene historial de ejecuciones de payroll con recibos Arweave",
        "authentication": "None",
        "request": {},
        "response": {
          "200": {
            "activity": [
              {
                "id": "pay_xxx",
                "status": "PAID",
                "totalAmount": "1000.00",
                "currency": "USD",
                "recipientCount": 10,
                "createdAt": "ISO 8601",
                "arweave": {
                  "url": "https://arweave.net/txId",
                  "txId": "arweave-transaction-id",
                  "status": "Immutable • Verifiable • Compliance-Ready"
                },
                "payments": [
                  {
                    "id": "pmt_1",
                    "amount": "100.00",
                    "currency": "USD",
                    "recipient": "email@example.com",
                    "status": "PAID"
                  }
                ]
              }
            ],
            "stats": {
              "totalPayrolls": 5,
              "totalPaid": 5000.00,
              "totalRecipients": 50
            }
          }
        }
      },
      "agentStats": {
        "method": "GET",
        "path": "/api/agent/stats",
        "description": "Obtiene estadísticas operacionales en tiempo real",
        "authentication": "None",
        "request": {},
        "response": {
          "200": {
            "summary": {
              "totalPayrolls": 10,
              "totalPaidPayrolls": 8,
              "totalProcessingPayrolls": 1,
              "totalFailedPayrolls": 1
            },
            "amounts": {
              "totalPaid": 10000.00,
              "totalProcessing": 1000.00,
              "currency": "USD"
            },
            "recipients": {
              "total": 100
            },
            "system": {
              "uptime": "5h 30m 15s",
              "timestamp": "ISO 8601",
              "nodeVersion": "v18.0.0",
              "platform": "darwin",
              "arch": "arm64"
            },
            "payrolls": {
              "total": 10,
              "last24h": 3,
              "byStatus": {
                "PAID": 8,
                "RAIL_PROCESSING": 1,
                "FAILED": 1
              }
            }
          }
        }
      },
      "payrollExecute": {
        "method": "POST",
        "path": "/api/payroll/execute",
        "description": "Ejecuta un payroll demo con 10 pagos a freelancers",
        "authentication": "x402 (X-PAYMENT header)",
        "request": {
          "headers": {
            "X-PAYMENT": "demo-token | EIP-3009 signed authorization",
            "Content-Type": "application/json"
          },
          "body": {}
        },
        "response": {
          "402": {
            "error": "PAYMENT_REQUIRED",
            "meterId": "payroll_execute",
            "metering": {
              "price": "1",
              "asset": "USDC",
              "chain": "avalanche",
              "resource": "payroll_execution",
              "version": "8004-alpha"
            }
          },
          "200": {
            "payrollId": "pay_xxx",
            "status": "PAID",
            "total": 1000.00,
            "currency": "USD",
            "payments": [
              {
                "id": "pmt_1",
                "recipient": "john@example.com",
                "amount": 100.00,
                "status": "PAID"
              }
            ],
            "arweave": {
              "url": "https://arweave.net/txId",
              "txId": "arweave-transaction-id"
            }
          }
        }
      },
      "payrollGetById": {
        "method": "GET",
        "path": "/api/payroll/:id",
        "description": "Obtiene detalles de un payroll por ID",
        "authentication": "None",
        "request": {
          "params": {
            "id": "pay_xxx (string)"
          }
        },
        "response": {
          "200": {
            "id": "pay_xxx",
            "status": "PAID",
            "total": 1000.00,
            "currency": "USD",
            "createdAt": "ISO 8601",
            "updatedAt": "ISO 8601",
            "payments": [
              {
                "id": "pmt_1",
                "recipient": "john@example.com",
                "amount": 100.00,
                "currency": "USD",
                "status": "PAID"
              }
            ]
          },
          "404": {
            "error": "PAYROLL_NOT_FOUND",
            "message": "Payroll ID doesn't exist"
          }
        }
      },
      "paymentProcess": {
        "method": "POST",
        "path": "/api/payment/process",
        "description": "Procesa un pago individual (Rail + on-chain)",
        "authentication": "x402 (X-PAYMENT header)",
        "request": {
          "headers": {
            "X-PAYMENT": "demo-token | EIP-3009 signed authorization",
            "Content-Type": "application/json"
          },
          "body": {
            "recipient": "john@example.com",
            "amount": 100.00,
            "currency": "USD",
            "customer": {
              "first_name": "John",
              "last_name": "Doe",
              "email_address": "john@example.com",
              "telephone_number": "optional",
              "mailing_address": {
                "address_line1": "123 Main St",
                "city": "New York",
                "state": "NY",
                "postal_code": "10001",
                "country_code": "US"
              }
            },
            "payment": {
              "amount": 10000,
              "currency": "USD",
              "recipient": "optional",
              "description": "optional"
            }
          }
        },
        "response": {
          "402": {
            "error": "PAYMENT_REQUIRED",
            "metering": {
              "price": "1",
              "asset": "USDC",
              "meterId": "payment_process"
            }
          },
          "200": {
            "success": true,
            "payrollId": "pay_xxx",
            "status": "PAID",
            "steps": {
              "payroll_created": true,
              "payments_created": true,
              "treasury_checked": true,
              "onchain_requested": true,
              "onchain_executed": true,
              "rail_processed": true
            },
            "transactions": {
              "request_tx_hashes": ["0x..."],
              "execute_tx_hashes": ["0x..."]
            },
            "rail": {
              "withdrawal_id": "w_xxx",
              "status": "PAID"
            },
            "errors": []
          }
        }
      },
      "treasuryBalance": {
        "method": "GET",
        "path": "/api/treasury/balance",
        "description": "Obtiene balance USDC de la tesorería",
        "authentication": "None",
        "request": {},
        "response": {
          "200": {
            "balance": "1000.50",
            "asset": "USDC",
            "network": "avalanche-fuji",
            "contractAddress": "0x..."
          }
        }
      },
      "treasuryTest": {
        "method": "POST",
        "path": "/api/treasury/test",
        "description": "Prueba operaciones del contrato treasury (para agentes IA)",
        "authentication": "x402 (X-PAYMENT header)",
        "request": {
          "headers": {
            "X-PAYMENT": "demo-token | EIP-3009 signed authorization",
            "Content-Type": "application/json"
          },
          "body": {}
        },
        "response": {
          "200": {
            "success": true,
            "message": "Contract test successful",
            "balance": "1000.50 USDC",
            "network": "avalanche-fuji",
            "results": [
              {
                "step": "balance_check",
                "success": true,
                "balance": "1000000000",
                "formatted": "1000.00"
              }
            ],
            "transactionHashes": ["0x..."],
            "summary": {
              "total": 5,
              "successful": 5,
              "failed": 0
            }
          }
        }
      },
      "processA2A": {
        "method": "POST",
        "path": "/process",
        "description": "Endpoint compatible A2A para requests de agentes IA",
        "authentication": "x402 (X-PAYMENT header)",
        "request": {
          "headers": {
            "X-PAYMENT": "EIP-3009 signed authorization",
            "Content-Type": "application/json"
          },
          "body": {
            "message": {
              "messageId": "msg-123",
              "role": "user",
              "parts": [
                {
                  "kind": "text",
                  "text": "Process my payroll"
                }
              ],
              "metadata": {
                "x402.payment.payload": "eip3009-signed-authorization",
                "x402.payment.status": "payment-submitted",
                "agent.id": "agent-abc-123"
              }
            }
          }
        },
        "response": {
          "200": {
            "success": true,
            "result": {
              "payrollId": "pay_xxx",
              "status": "PAID"
            }
          }
        }
      },
      "facilitatorHealth": {
        "method": "GET",
        "path": "/facilitator/health",
        "description": "Verifica estado del facilitator",
        "authentication": "None",
        "request": {},
        "response": {
          "200": {
            "status": "ok",
            "facilitator": "x402-snowrail",
            "version": "1.0.0"
          }
        }
      },
      "facilitatorValidate": {
        "method": "POST",
        "path": "/facilitator/validate",
        "description": "Valida prueba de pago",
        "authentication": "None",
        "request": {
          "body": {
            "payment": "demo-token | EIP-3009 authorization"
          }
        },
        "response": {
          "200": {
            "valid": true,
            "meterId": "payroll_execute"
          }
        }
      },
      "facilitatorVerify": {
        "method": "POST",
        "path": "/facilitator/verify",
        "description": "Verifica firma EIP-3009",
        "authentication": "None",
        "request": {
          "body": {
            "signature": "0x...",
            "from": "0x...",
            "to": "0x...",
            "value": "1000000",
            "validAfter": 0,
            "validBefore": 9999999999,
            "nonce": "0x..."
          }
        },
        "response": {
          "200": {
            "valid": true,
            "signer": "0x..."
          }
        }
      },
      "facilitatorSettle": {
        "method": "POST",
        "path": "/facilitator/settle",
        "description": "Liquida pago on-chain",
        "authentication": "None",
        "request": {
          "body": {
            "paymentProof": "eip3009-authorization",
            "meterId": "payroll_execute"
          }
        },
        "response": {
          "200": {
            "success": true,
            "txHash": "0x...",
            "settled": true
          }
        }
      },
      "authSignup": {
        "method": "POST",
        "path": "/auth/signup",
        "description": "Crea nueva cuenta de usuario y compañía (KYB Level 0)",
        "authentication": "None",
        "request": {
          "body": {
            "email": "user@example.com",
            "password": "securePassword123",
            "companyLegalName": "My Company Inc",
            "country": "US (optional, default: US)"
          }
        },
        "response": {
          "201": {
            "token": "JWT token",
            "user": {
              "id": "user_id",
              "email": "user@example.com",
              "companyId": "company_id"
            },
            "company": {
              "id": "company_id",
              "legalName": "My Company Inc",
              "kybLevel": 0,
              "kybStatus": "none",
              "railStatus": "none"
            }
          },
          "400": {
            "error": "EMAIL_EXISTS | INVALID_REQUEST | INVALID_EMAIL_FORMAT",
            "message": "Human-readable error message"
          }
        }
      },
      "authLogin": {
        "method": "POST",
        "path": "/auth/login",
        "description": "Autentica usuario y retorna JWT token",
        "authentication": "None",
        "request": {
          "body": {
            "email": "user@example.com",
            "password": "securePassword123"
          }
        },
        "response": {
          "200": {
            "token": "JWT token",
            "user": {
              "id": "user_id",
              "email": "user@example.com",
              "companyId": "company_id"
            },
            "company": {
              "id": "company_id",
              "legalName": "My Company Inc",
              "kybLevel": 0,
              "kybStatus": "none",
              "railStatus": "none"
            }
          },
          "401": {
            "error": "INVALID_CREDENTIALS",
            "message": "Invalid email or password"
          }
        }
      },
      "authMe": {
        "method": "GET",
        "path": "/auth/me",
        "description": "Obtiene información del usuario autenticado actual",
        "authentication": "JWT (Bearer token)",
        "request": {
          "headers": {
            "Authorization": "Bearer <JWT_TOKEN>"
          }
        },
        "response": {
          "200": {
            "user": {
              "id": "user_id",
              "email": "user@example.com",
              "companyId": "company_id"
            },
            "company": {
              "id": "company_id",
              "legalName": "My Company Inc",
              "tradeName": "optional",
              "country": "US",
              "kybLevel": 0,
              "kybStatus": "none",
              "railStatus": "none"
            }
          },
          "401": {
            "error": "UNAUTHORIZED",
            "message": "Unauthorized - please log in again"
          }
        }
      },
      "dashboard": {
        "method": "GET",
        "path": "/api/dashboard",
        "description": "Obtiene datos del dashboard para compañía autenticada",
        "authentication": "JWT (Bearer token)",
        "request": {
          "headers": {
            "Authorization": "Bearer <JWT_TOKEN>"
          }
        },
        "response": {
          "200": {
            "balance": {
              "usdc": "1000.50",
              "currency": "USD"
            },
            "recentPayments": [],
            "stats": {}
          }
        }
      },
      "internalCallback": {
        "method": "POST",
        "path": "/internal/x402/callback",
        "description": "Endpoint interno llamado por facilitator cuando pago es confirmado on-chain",
        "authentication": "X-Callback-Secret header",
        "request": {
          "headers": {
            "X-Callback-Secret": "secret_key (si está configurado)"
          },
          "body": {
            "paymentIntentId": "payment_intent_id",
            "token": "USDC",
            "amount": 100,
            "txHash": "0x...",
            "timestamp": "ISO 8601 (optional)"
          }
        },
        "response": {
          "200": {
            "ok": true,
            "message": "Payment confirmed and balance updated",
            "companyId": "company_id",
            "paymentIntentId": "payment_intent_id",
            "status": "CONFIRMED",
            "txHash": "0x...",
            "balanceUpdated": true
          }
        }
      }
    }
  },
  "authentication": {
    "jwt": {
      "purpose": "Autenticación de usuarios humanos (Dashboard)",
      "endpoints": ["/auth/login", "/auth/signup", "/auth/me", "/api/dashboard"],
      "flow": [
        "1. POST /auth/signup o /auth/login",
        "2. Recibir JWT token en response",
        "3. Incluir header: Authorization: Bearer <token>"
      ],
      "tokenStructure": {
        "userId": "string",
        "companyId": "string",
        "exp": "number (expiration timestamp)"
      }
    },
    "x402": {
      "purpose": "Autenticación de agentes IA para pagos programáticos",
      "protocol": "HTTP 402 Payment Required",
      "endpoints": ["/api/payroll/execute", "/api/payment/process", "/api/treasury/test", "/process"],
      "flow": [
        "1. Agente hace request a endpoint protegido",
        "2. API retorna 402 Payment Required con metering info",
        "3. Agente firma autorización EIP-3009 localmente (USDC Permit)",
        "4. Agente reintenta request con header X-PAYMENT conteniendo autorización firmada",
        "5. API valida firma, liquida fondos on-chain, ejecuta operación"
      ],
      "headerFormat": {
        "X-PAYMENT": "demo-token (testnet) | JSON stringified EIP-3009 authorization (production)"
      },
      "eip3009Structure": {
        "from": "0x... (payer address)",
        "to": "0x... (receiver address)",
        "value": "string (amount in wei/smallest unit)",
        "validAfter": "number (timestamp)",
        "validBefore": "number (timestamp)",
        "nonce": "0x... (hex string)",
        "signature": "0x... (hex string, 65 bytes)"
      }
    }
  },
  "errorCodes": {
    "PAYMENT_REQUIRED": {
      "httpStatus": 402,
      "meaning": "Falta pago x402",
      "solution": "Firmar y enviar header X-PAYMENT con autorización EIP-3009"
    },
    "INVALID_PAYMENT": {
      "httpStatus": 400,
      "meaning": "Prueba de pago inválida",
      "solution": "Verificar formato y firma de autorización EIP-3009"
    },
    "PAYROLL_NOT_FOUND": {
      "httpStatus": 404,
      "meaning": "Payroll ID no existe",
      "solution": "Verificar ID del payroll"
    },
    "INSUFFICIENT_BALANCE": {
      "httpStatus": 400,
      "meaning": "Tesorería sin saldo suficiente",
      "solution": "Enviar USDC al contrato SnowRailTreasury"
    },
    "CONTRACT_ERROR": {
      "httpStatus": 500,
      "meaning": "Error en interacción con smart contract",
      "solution": "Verificar RPC URL, contract address, y saldo de gas"
    },
    "INVALID_CREDENTIALS": {
      "httpStatus": 401,
      "meaning": "Email o password incorrectos",
      "solution": "Verificar credenciales"
    },
    "UNAUTHORIZED": {
      "httpStatus": 401,
      "meaning": "Token JWT inválido o expirado",
      "solution": "Renovar token con /auth/login"
    },
    "EMAIL_EXISTS": {
      "httpStatus": 400,
      "meaning": "Email ya está registrado",
      "solution": "Usar otro email o hacer login"
    },
    "RAIL_ERROR": {
      "httpStatus": 502,
      "meaning": "Error en proveedor Fiat (Rail API)",
      "solution": "Verificar límites de cuenta en Rail o datos del beneficiario"
    },
    "INVALID_SIGNATURE": {
      "httpStatus": 401,
      "meaning": "Firma EIP-3009 inválida",
      "solution": "Verificar nonce y chainId al firmar"
    }
  },
  "paymentStatuses": {
    "PENDING": "Pago creado, esperando procesamiento",
    "ONCHAIN_REQUESTED": "Solicitud de pago on-chain creada",
    "ONCHAIN_PAID": "Pago on-chain completado",
    "RAIL_PROCESSING": "Rail API procesando salida fiat",
    "PAID": "Pago completado exitosamente",
    "FAILED": "Pago falló en cualquier etapa"
  },
  "webhooks": {
    "purpose": "Sincronización de eventos para integraciones externas",
    "authentication": "X-Callback-Secret header (validación opcional)",
    "endpoint": "POST /internal/x402/callback",
    "events": {
      "payment.onchain_confirmed": {
        "description": "Pago liquidado en blockchain",
        "payload": {
          "paymentIntentId": "string",
          "token": "USDC",
          "amount": 100,
          "txHash": "0x...",
          "timestamp": "ISO 8601"
        }
      },
      "payment.rail_processed": {
        "description": "Transferencia fiat completada",
        "payload": {
          "withdrawalId": "string",
          "status": "PAID | FAILED",
          "timestamp": "ISO 8601"
        }
      },
      "payment.failed": {
        "description": "Fallo en cualquier etapa",
        "payload": {
          "error": "string",
          "step": "string",
          "payrollId": "string",
          "timestamp": "ISO 8601"
        }
      }
    }
  },
  "codeExamples": {
    "typescript": {
      "executePayrollWithX402": "async function executePayroll() {\n  // 1. Intentar ejecución (fallará con 402)\n  const initialRes = await fetch('https://api.snowrail.xyz/api/payroll/execute', {\n    method: 'POST',\n    headers: { 'Content-Type': 'application/json' }\n  });\n\n  if (initialRes.status === 402) {\n    const { metering, meterId } = await initialRes.json();\n    \n    // 2. Obtener prueba de pago (Firma EIP-3009)\n    const proof = await getPaymentProofFromFacilitator(metering, meterId);\n    \n    // 3. Reintentar con header de pago\n    const finalRes = await fetch('https://api.snowrail.xyz/api/payroll/execute', {\n      method: 'POST',\n      headers: { \n        'Content-Type': 'application/json',\n        'X-PAYMENT': proof \n      }\n    });\n    \n    return await finalRes.json();\n  }\n}"
    },
    "curl": {
      "getAgentIdentity": "curl -X GET https://api.snowrail.xyz/api/agent/identity",
      "executePayrollWithPayment": "curl -X POST https://api.snowrail.xyz/api/payroll/execute \\\n  -H 'Content-Type: application/json' \\\n  -H 'X-PAYMENT: demo-token'",
      "getTreasuryBalance": "curl -X GET https://api.snowrail.xyz/api/treasury/balance",
      "processPayment": "curl -X POST https://api.snowrail.xyz/api/payment/process \\\n  -H 'Content-Type: application/json' \\\n  -H 'X-PAYMENT: demo-token' \\\n  -d '{\n    \"recipient\": \"john@example.com\",\n    \"amount\": 100.00,\n    \"currency\": \"USD\"\n  }'",
      "authLogin": "curl -X POST https://api.snowrail.xyz/auth/login \\\n  -H 'Content-Type: application/json' \\\n  -d '{\n    \"email\": \"user@example.com\",\n    \"password\": \"password123\"\n  }'"
    }
  },
  "projectStructure": {
    "root": "/Users/josue/OSS/ColombiaBlockChain/SnowRail",
    "directories": {
      "/contracts": {
        "description": "Smart contracts Solidity",
        "files": [
          "SnowRailTreasury.sol",
          "hardhat.config.js",
          "package.json",
          "scripts/deploy.js"
        ]
      },
      "/backend": {
        "description": "Node.js backend (Express + x402)",
        "keyFiles": {
          "src/server.ts": "Entrypoint del servidor Express",
          "src/api/": "Rutas API (payrollRoutes, paymentRoutes, authRoutes, agentRoutes, treasury.controller)",
          "src/services/": "Lógica de negocio (paymentService, payrollService, railClient, arweaveService)",
          "src/x402/": "Implementación x402 (facilitatorServer, middleware, agentIdentity, metering)",
          "src/config/": "Configuración (env.ts, networkConfig.ts, contractConfig.ts)",
          "prisma/schema.prisma": "Schema de base de datos"
        }
      },
      "/frontend": {
        "description": "React frontend",
        "keyFiles": {
          "src/App.tsx": "Orchestration y routing",
          "src/components/": "Componentes UI",
          "src/pages/": "Páginas",
          "src/hooks/": "Lógica de negocio",
          "src/lib/api.ts": "Cliente API"
        }
      },
      "/docs": {
        "description": "Documentación",
        "files": [
          "FULL_TECHNICAL_DOCUMENTATION.md",
          "API_REFERENCE.md",
          "SOVEREIGN_AGENT_STACK.md",
          "DEPLOYMENT.md"
        ]
      }
    }
  },
  "environmentVariables": {
    "backend": {
      "PORT": "Puerto del servidor (default: 4000)",
      "NETWORK": "fuji | avalanche",
      "RPC_URL_AVALANCHE": "URL del RPC de Avalanche",
      "TREASURY_CONTRACT_ADDRESS": "Dirección del contrato SnowRailTreasury",
      "PRIVATE_KEY": "Clave privada para firmar transacciones (0x...)",
      "DATABASE_URL": "URL de conexión a base de datos",
      "RAIL_API_BASE_URL": "URL base de Rail API",
      "RAIL_AUTH_URL": "URL de autenticación OAuth2 de Rail",
      "RAIL_CLIENT_ID": "Client ID de Rail OAuth2",
      "RAIL_CLIENT_SECRET": "Client Secret de Rail OAuth2",
      "RAIL_SOURCE_ACCOUNT_ID": "ID de cuenta fuente en Rail",
      "RAIL_COUNTERPARTY_ID": "ID de contraparte en Rail",
      "ARWEAVE_JWK": "JSON Web Key para Arweave (opcional)",
      "X402_CALLBACK_SECRET": "Secret para validar callbacks de x402 (opcional)",
      "JWT_SECRET": "Secret para firmar tokens JWT",
      "CORS_ALLOWED_ORIGINS": "Orígenes permitidos para CORS (comma-separated)"
    },
    "contracts": {
      "PRIVATE_KEY": "Clave privada para desplegar contratos",
      "ROUTER_ADDRESS_FUJI": "Dirección del router de Trader Joe en Fuji",
      "ROUTER_ADDRESS_AVALANCHE": "Dirección del router de Trader Joe en Mainnet"
    }
  },
  "deployment": {
    "smartContract": {
      "steps": [
        "1. cd contracts",
        "2. npm install",
        "3. Configurar PRIVATE_KEY y ROUTER_ADDRESS",
        "4. npm run deploy:fuji (testnet) o deploy:mainnet (producción)",
        "5. Guardar TREASURY_CONTRACT_ADDRESS"
      ]
    },
    "backend": {
      "steps": [
        "1. cd backend",
        "2. npm install",
        "3. cp env.example .env",
        "4. Configurar variables de entorno",
        "5. npx prisma migrate dev --name init",
        "6. npm run dev"
      ]
    },
    "frontend": {
      "steps": [
        "1. cd frontend",
        "2. npm install",
        "3. Configurar VITE_API_BASE_URL en .env",
        "4. npm run dev"
      ]
    }
  },
  "testing": {
    "backendTests": "cd backend && npm test",
    "contractTests": "cd contracts && npx hardhat test",
    "integrationTests": "npm run test:integration"
  },
  "resources": {
    "github": "https://github.com/Colombia-Blockchain/SnowRail",
    "avalancheDocs": "https://docs.avax.network/",
    "x402Protocol": "https://github.com/eigensphere/x402",
    "erc8004": "https://github.com/eigensphere/eips",
    "arweave": "https://www.arweave.org/",
    "railDocs": "https://docs.layer2financial.com",
    "snowtrace": "https://testnet.snowtrace.io (Fuji) | https://snowtrace.io (Mainnet)"
  }
}
